ncol=15, height = 5, width = 6)
Go_barchart(psIN = ps2, project = project, cutoff = 0.005, simple = F, relative = T,
taxanames =c("Order","Family"),
cate.vars=c("Group"), facet = "Time",, legend = "bottom",
orders = orders,  x_label = NULL, mycols = barplot.col,
name = "OF",
ncol=15, height = 5.3, width = 6)
Go_barchart(psIN = ps2, project = project, cutoff = 0.005, simple = F, relative = T,
taxanames =c("Genus","Species"),
cate.vars=c("Group"), facet = "Time",, legend = "bottom",
orders = orders,  x_label = NULL, mycols = barplot.col,
name = "GS_Large",
ncol=15, height = 5.8, width = 9)
Go_barchart(psIN = ps2, project = project, cutoff = 0.005, simple = F, relative = T,
taxanames =c("Genus","Species"),
cate.vars=c("Group"), facet = "Time",, legend = "bottom",
orders = orders,  x_label = NULL, mycols = barplot.col,
name = "GS_Large",
ncol=15, height = 5.8, width = 10)
Go_barchart(psIN = ps2, project = project, cutoff = 0.005, simple = F, relative = T,
taxanames =c("Genus","Species"),
cate.vars=c("Group"), facet = "Time",, legend = "bottom",
orders = orders,  x_label = NULL, mycols = barplot.col,
name = "GS_Large",
ncol=15, height = 6.5, width = 10)
#===== alpha diversity
adiv.col <- Go_myCols(piratepal = "basel")
adiv.col <-  c("#026CCBFF",  "#05B102FF","#F51E02FF","#FB82BEFF", "#F57206FF", "#EEC229FF",  "#5AC2F1FF")
adiv <- Go_adiv(psIN = ps2,  project = project, alpha_metrics = c("Chao1","Shannon"));dim(adiv)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Group"), statistics = T,
outcomes = c("Chao1","Shannon"), addnumber = F, cutoff = 0.1,
orders = orders, star= F, facet = "Time", name = NULL,
height = 3, width = 4, plotCols=2, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Group"), statistics = T,
outcomes = c("Chao1","Shannon"), addnumber = F, cutoff = 0.1,
orders = orders, star= F, facet = "Time", name = NULL,
height = 3, width = 8, plotCols=2, plotRows=1, standardsize = F)
adiv <- Go_adiv(psIN = ps2,  project = project, alpha_metrics = c("Chao1","Shannon","PD"));dim(adiv)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Group"), statistics = T,
outcomes = c("Chao1","Shannon","PD"), addnumber = F, cutoff = 0.1,
orders = orders, star= F, facet = "Time", name = NULL,
height = 8, width = 4, plotCols=2, plotRows=3, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Group"), statistics = T,
outcomes = c("Chao1","Shannon","PD"), addnumber = F, cutoff = 0.1,
orders = orders, star= F, facet = "Time", name = NULL,
height = 8, width = 4, plotCols=1, plotRows=3, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Group"), statistics = T,
outcomes = c("Chao1","Shannon","PD"), addnumber = F, cutoff = 0.1,
orders = orders, star= F, facet = "Time", name = NULL,
height = 6, width = 5, plotCols=1, plotRows=3, standardsize = F)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Timepoint",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =2.5 , width = 3.5)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =2.5 , width = 3.5)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 3.5)
Go_groupBoxTimepoint(df = adiv.sel, project, maingroup = "Group",timepoint = "Time",
outcomes =  c("Sub0_Chao1","Sub0_Shannon","Sub0_PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 3.5)
#== substate
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, tp == "wk1_Post")
#== Index match
matched_indices <- match(adiv.sel$UID, adiv.sel.D0$UID)
adiv.sel$Chao1_D0 <- adiv.sel.D0$Chao1[matched_indices]
adiv.sel$Shannon_D0 <- adiv.sel.D0$Shannon[matched_indices]
adiv.sel$PD_D0 <- adiv.sel.D0$PD[matched_indices]
#===== groupBox substate
adiv.sel <- adiv
unique(map$Time)
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, tp == "Baseline")
#== Index match
matched_indices <- match(adiv.sel$UID, adiv.sel.D0$UID)
adiv.sel$Chao1_D0 <- adiv.sel.D0$Chao1[matched_indices]
adiv.sel$Shannon_D0 <- adiv.sel.D0$Shannon[matched_indices]
adiv.sel$PD_D0 <- adiv.sel.D0$PD[matched_indices]
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, tp == "Baseline")
#== Index match
matched_indices <- match(adiv.sel$SubjectID, adiv.sel.D0$SubjectID)
adiv.sel$Chao1_D0 <- adiv.sel.D0$Chao1[matched_indices]
adiv.sel$Shannon_D0 <- adiv.sel.D0$Shannon[matched_indices]
adiv.sel$PD_D0 <- adiv.sel.D0$PD[matched_indices]
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
#== substate
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
Go_groupBoxTimepoint(df = adiv.sel, project, maingroup = "Group",timepoint = "Time",
outcomes =  c("Sub0_Chao1","Sub0_Shannon","Sub0_PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 3.5)
orders
adiv.sel$Sub0_Chao1
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, tp == "Baseline")
#== Index match
matched_indices <- match(adiv.sel$SubjectID, adiv.sel.D0$SubjectID)
adiv.sel$Chao1_D0 <- adiv.sel.D0$Chao1[matched_indices]
adiv.sel$Shannon_D0 <- adiv.sel.D0$Shannon[matched_indices]
adiv.sel$PD_D0 <- adiv.sel.D0$PD[matched_indices]
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
#== substate
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
Go_groupBoxTimepoint(df = adiv.sel, project, maingroup = "Group",timepoint = "Time",
outcomes =  c("Sub0_Chao1","Sub0_Shannon","Sub0_PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 3.5)
adiv.sel$Sub0_PD
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, tp == "Baseline")
adiv.sel.D0
#===== groupBox substate
adiv.sel <- adiv
adiv.sel.D0 <- subset(adiv.sel, Time == "Baseline")
#== Index match
matched_indices <- match(adiv.sel$SubjectID, adiv.sel.D0$SubjectID)
adiv.sel$Chao1_D0 <- adiv.sel.D0$Chao1[matched_indices]
adiv.sel$Shannon_D0 <- adiv.sel.D0$Shannon[matched_indices]
adiv.sel$PD_D0 <- adiv.sel.D0$PD[matched_indices]
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
#== substate
adiv.sel$Sub0_Chao1  <- adiv.sel$Chao1 - adiv.sel$Chao1_D0
adiv.sel$Sub0_Shannon  <- adiv.sel$Shannon - adiv.sel$Shannon_D0
adiv.sel$Sub0_PD  <- adiv.sel$PD - adiv.sel$PD_D0
Go_groupBoxTimepoint(df = adiv.sel, project, maingroup = "Group",timepoint = "Time",
outcomes =  c("Sub0_Chao1","Sub0_Shannon","Sub0_PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 3.5)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv.sel, project, maingroup = "Group",timepoint = "Time",
outcomes =  c("Sub0_Chao1","Sub0_Shannon","Sub0_PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_boxplotLMM(df=adiv, project = project, title = mvar, xangle = 90,  mycols = boxcol.visit,combination = NULL,
cate.vars = c("Group"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
Go_boxplotLMM(df=adiv, project = project, title = mvar, xangle = 90,  mycols = boxcol.visit,combination = NULL,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
Go_boxplotLMM(df=adiv, project = project, title = mvar, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
adiv <- Go_adiv(psIN = ps2,  project = project, alpha_metrics = c("Chao1","Shannon","PD"));dim(adiv)
Go_boxplotLMM(df=adiv, project = project, title = mvar, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
Go_boxplotLMM(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
Go_boxplotLMM(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
Go_boxplotLMM(df=adiv, project = project, title = NULL, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = "Group", name = NULL, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
mvars <- c("Fasted","Full")
for(mvar in mvars){
adiv.sel <- subset(adiv, Group == "Yes")
Go_boxplotLMM(df=adiv.sel, project = project, title = mvars, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvars, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
}
mvars <- c("Fasted","Full")
for(mvar in mvars){
adiv.sel <- subset(adiv, Group == mvars)
Go_boxplotLMM(df=adiv.sel, project = project, title = mvars, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvars, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
}
mvars
mvars <- c("Fasted","Full")
for(mvar in mvars){
adiv.sel <- subset(adiv, Group == mvar)
Go_boxplotLMM(df=adiv.sel, project = project, title = mvar, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 5, plotCols=2, plotRows=1, standardsize = F)
}
mvars <- c("Fasted","Full")
for(mvar in mvars){
adiv.sel <- subset(adiv, Group == mvar)
Go_boxplotLMM(df=adiv.sel, project = project, title = mvar, xangle = 90,  mycols = adiv.col, combination = 4,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 8, plotCols=3, plotRows=1, standardsize = F)
}
mvars <- c("Fasted","Full")
for(mvar in mvars){
adiv.sel <- subset(adiv, Group == mvar)
Go_boxplotLMM(df=adiv.sel, project = project, title = mvar, xangle = 90,  mycols = adiv.col, combination = NULL,
cate.vars = c("Time"), outcomes =c("Chao1","Shannon","PD"), addnumber = T, paired = "SubjectID",
orders = orders, star= F, facet = NULL, name = mvar, cutoff = 0.9,
height = 3.2, width = 8, plotCols=3, plotRows=1, standardsize = F)
}
#===== Beta diversyty
bdiv.col <-  c("#026CCBFF",  "#05B102FF","#F51E02FF","#FB82BEFF", "#F57206FF", "#EEC229FF",  "#5AC2F1FF")
log_phyloseq <- transform_sample_counts(ps2, function(x) log(1+x))
#===== Beta diversyty
bdiv.col <-  c("#026CCBFF",  "#05B102FF","#F51E02FF","#FB82BEFF", "#F57206FF", "#EEC229FF",  "#5AC2F1FF")
log_phyloseq <- transform_sample_counts(ps2, function(x) log(1+x))
Go_bdivPM(psIN = log_phyloseq,  project = project, mycols = bdiv.col, statistics = T,
cate.vars = "Group", orders = orders, cate.conf = NULL,addnumber = F,
combination = NULL, distance_metrics = c("unifrac", "wunifrac", "bray"), plot = c("PCoA"),
shapes =NULL, ID = NULL, ellipse=T, facet = "Time", name = NULL, height = 4, width = 8)
Go_groupBoxTimepoint <- function(df = NULL,
project = NULL,
name = NULL,
maingroup = NULL,
timepoint = NULL,
outcomes = NULL,
mycols = NULL,
orders = NULL,
fill_labels = NULL,
title = NULL,
x.axis = NULL,
height = NULL,
width = NULL,
baseline = NULL,   # 추가
paired = NULL) {   # 추가
library(dplyr)
library(ggplot2)
library(ggpubr)
if (is.null(df)) stop("Input dataframe (df) is required.")
if (is.null(project)) stop("Project name is required.")
df.sel <- df
if (is.null(mycols)) {
print("mycols is not defined. Default colors will be used.")
}
if (is.null(orders)) {
print("orders is not defined.")
}
if (is.null(height)) height <- 3.5
if (is.null(width)) width <- 5
#--------------------------------------------
# baseline 보정(subtraction) 수행
#--------------------------------------------
if (!is.null(baseline) && !is.null(paired)) {
if (baseline %in% unique(df.sel[[timepoint]])) {
message(sprintf("Performing baseline subtraction using baseline = '%s' and paired = '%s'", baseline, paired))
df.base <- subset(df.sel, df.sel[[timepoint]] == baseline)
matched_indices <- match(df.sel[[paired]], df.base[[paired]])
# outcomes 중 실제 존재하는 것만 사용
outcomes.exist <- outcomes[outcomes %in% colnames(df.sel)]
for (var in outcomes.exist) {
baseline_col <- paste0(var, "_D0")
sub_col <- paste0("Sub0_", var)
df.sel[[baseline_col]] <- df.base[[var]][matched_indices]
df.sel[[sub_col]] <- df.sel[[var]] - df.sel[[baseline_col]]
}
# outcomes 갱신 (Sub0_ prefix 적용)
outcomes <- paste0("Sub0_", outcomes.exist)
} else {
warning("Baseline value not found in timepoint column. Skipping baseline subtraction.")
}
}
#--------------------------------------------
# 변수별 boxplot 작성
#--------------------------------------------
for (variable in outcomes) {
if (!is.null(dev.list())) dev.off()
if (!variable %in% colnames(df.sel)) {
warning(sprintf("Variable '%s' not found in dataframe. Skipping.", variable))
next
}
average_data <- df.sel %>%
dplyr::group_by(!!sym(timepoint), !!sym(maingroup)) %>%
dplyr::summarise(
!!paste0("mean_", variable) := mean(!!sym(variable), na.rm = TRUE),
.groups = "drop"
) %>%
ungroup()
if (!is.null(orders)) {
df.sel[, timepoint] <- factor(df.sel[, timepoint], levels = intersect(orders, df.sel[, timepoint]))
df.sel[, maingroup] <- factor(df.sel[, maingroup], levels = intersect(orders, df.sel[, maingroup]))
}
max_label_y <- if (all(is.na(df.sel[[variable]]))) 1 else max(df.sel[[variable]], na.rm = TRUE) + 0.2
p <- ggplot(df.sel, aes_string(x = timepoint, y = variable, fill = maingroup)) +
geom_boxplot(outlier.shape = NA, lwd = 0.3) +
geom_line(data = average_data, aes_string(x = timepoint, y = sprintf("mean_%s", variable), group = maingroup, colour = maingroup), size = 1, alpha = 0.4) +
geom_point(aes_string(colour = maingroup), position = position_dodge(width = 0.75), size = 1.5, alpha = 0.8) +
theme_bw() +
theme(legend.position = "bottom", legend.title = element_blank()) +
labs(y = variable, x = NULL) +
stat_compare_means(method = "wilcox.test", label = "p.format",
aes_string(group = maingroup),
label.y = max_label_y)
if (!is.null(mycols)) {
p <- p + scale_fill_manual(values = mycols, labels = fill_labels) +
scale_colour_manual(values = mycols, labels = fill_labels)
}
if (!is.null(title)) {
p <- p + ggtitle(sprintf("%s (%s)", title, "wilcox.test"))
} else {
p <- p + ggtitle(sprintf("%s (%s)", maingroup, "wilcox.test"))
}
dir <- Go_path(project, pdf = "yes", table = "no", path = NULL)
pdf(sprintf("%s/groupBox3.%s.%s.%s%s%s.pdf", dir$pdf,
project,
maingroup,
ifelse(is.null(variable), "", paste(variable, ".", sep = "")),
ifelse(is.null(name), "", paste(name, ".", sep = "")),
format(Sys.Date(), "%y%m%d")), height = height, width = width)
print(p)
dev.off()
}
}
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
baseline = "Baseline",paired = "SubjectID",
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
baseline = "Baseline",paired = "SubjectI",
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint <- function(df = NULL,
project = NULL,
name = NULL,
maingroup = NULL,
timepoint = NULL,
outcomes = NULL,
mycols = NULL,
orders = NULL,
fill_labels = NULL,
title = NULL,
x.axis = NULL,
height = NULL,
width = NULL,
baseline = NULL,   # 추가
paired = NULL) {   # 추가
library(dplyr)
library(ggplot2)
library(ggpubr)
if (is.null(df)) stop("Input dataframe (df) is required.")
if (is.null(project)) stop("Project name is required.")
df.sel <- df
if (is.null(mycols)) {
print("mycols is not defined. Default colors will be used.")
}
if (is.null(orders)) {
print("orders is not defined.")
}
if (is.null(height)) height <- 3.5
if (is.null(width)) width <- 5
#--------------------------------------------
# baseline 보정(subtraction) 수행
#--------------------------------------------
if (!is.null(baseline) && !is.null(paired)) {
if (baseline %in% unique(df.sel[[timepoint]])) {
message(sprintf("Performing baseline subtraction using baseline = '%s' and paired = '%s'", baseline, paired))
df.base <- subset(df.sel, df.sel[[timepoint]] == baseline)
matched_indices <- match(df.sel[[paired]], df.base[[paired]])
# outcomes 중 실제 존재하는 것만 사용
outcomes.exist <- outcomes[outcomes %in% colnames(df.sel)]
for (var in outcomes.exist) {
baseline_col <- paste0(var, "_D0")
sub_col <- paste0("Sub0_", var)
df.sel[[baseline_col]] <- df.base[[var]][matched_indices]
df.sel[[sub_col]] <- df.sel[[var]] - df.sel[[baseline_col]]
}
# outcomes 갱신 (Sub0_ prefix 적용)
outcomes <- paste0("Sub0_", outcomes.exist)
} else {
warning("Baseline value not found in timepoint column. Skipping baseline subtraction.")
}
}
#--------------------------------------------
# 변수별 boxplot 작성
#--------------------------------------------
for (variable in outcomes) {
if (!is.null(dev.list())) dev.off()
if (!variable %in% colnames(df.sel)) {
warning(sprintf("Variable '%s' not found in dataframe. Skipping.", variable))
next
}
average_data <- df.sel %>%
dplyr::group_by(!!sym(timepoint), !!sym(maingroup)) %>%
dplyr::summarise(
!!paste0("mean_", variable) := mean(!!sym(variable), na.rm = TRUE),
.groups = "drop"
) %>%
ungroup()
if (!is.null(orders)) {
df.sel[, timepoint] <- factor(df.sel[, timepoint], levels = intersect(orders, df.sel[, timepoint]))
df.sel[, maingroup] <- factor(df.sel[, maingroup], levels = intersect(orders, df.sel[, maingroup]))
}
max_label_y <- if (all(is.na(df.sel[[variable]]))) 1 else max(df.sel[[variable]], na.rm = TRUE) + 0.2
p <- ggplot(df.sel, aes_string(x = timepoint, y = variable, fill = maingroup)) +
geom_boxplot(outlier.shape = NA, lwd = 0.3) +
geom_line(data = average_data, aes_string(x = timepoint, y = sprintf("mean_%s", variable), group = maingroup, colour = maingroup), size = 1, alpha = 0.4) +
geom_point(aes_string(colour = maingroup), position = position_dodge(width = 0.75), size = 1.5, alpha = 0.8) +
theme_bw() +
theme(legend.position = "bottom", legend.title = element_blank()) +
labs(y = variable, x = NULL) +
stat_compare_means(method = "wilcox.test", label = "p.format",
aes_string(group = maingroup),
label.y = max_label_y)
if (!is.null(mycols)) {
p <- p + scale_fill_manual(values = mycols, labels = fill_labels) +
scale_colour_manual(values = mycols, labels = fill_labels)
}
if (!is.null(title)) {
p <- p + ggtitle(sprintf("%s (%s)", title, "wilcox.test"))
} else {
p <- p + ggtitle(sprintf("%s (%s)", maingroup, "wilcox.test"))
}
dir <- Go_path(project, pdf = "yes", table = "no", path = NULL)
pdf(sprintf("%s/groupBox3.%s.%s.%s%s%s.pdf", dir$pdf,
project,
maingroup,
ifelse(is.null(variable), "", paste(variable, ".", sep = "")),
ifelse(is.null(name), "", paste(name, ".", sep = "")),
format(Sys.Date(), "%y%m%d")), height = height, width = width)
print(p)
dev.off()
}
}
adiv.col <-  c("#5AC2F1FF", "#F57206FF")
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = adiv.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
group.col <-  c("#5AC2F1FF", "#F57206FF")
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = group.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
baseline = "Baseline",paired = "SubjectI",
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = group.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
baseline = "Baseline",paired = "SubjectID",
fill_labels = c("Fasted", "Full"), x.axis = unique(map$Time),
mycols = group.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
fill_labels = c("Full", "Fasted"), x.axis = unique(map$Time),
mycols = group.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
Go_groupBoxTimepoint(df = adiv, project, maingroup = "Group",timepoint = "Time",outcomes =  c("Chao1","Shannon","PD"),
baseline = "Baseline",paired = "SubjectID",
fill_labels = c("Full", "Fasted"), x.axis = unique(map$Time),
mycols = group.col, orders = orders, title= NULL,name = NULL,
height =3 , width = 4)
unique(map$Group)
orders <- c("Full","Fasted"  , unique(map$Time))
#===== Beta diversyty
bdiv.col <-   c("#5AC2F1FF", "#F57206FF")
log_phyloseq <- transform_sample_counts(ps2, function(x) log(1+x))
Go_bdivPM(psIN = log_phyloseq,  project = project, mycols = bdiv.col, statistics = T,
cate.vars = "Group", orders = orders, cate.conf = NULL,addnumber = F,
combination = NULL, distance_metrics = c("unifrac", "wunifrac", "bray"), plot = c("PCoA"),
shapes =NULL, ID = NULL, ellipse=T, facet = "Time", name = NULL, height = 4, width = 8)
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
