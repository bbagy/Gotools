TRUE ~ NA_character_          # <- 여기 중요!
)
) %>%
select(
`CP Short Title`:MRN_MDR,
MRN_MDR_fixed,
ACCNO_MDR,
`Collection Event#Date and Time`,
Date_collection_MDR_fixed,
Organism_name_common:`MAPS#Organism Name`,
CUIMC_clinical_isolate:`MAPS#Participant ID`,
Hospital_location,
Collection_site,
`Location#Position`,
Notes,
`MAPS#PI Name`
) %>%
distinct() %>%
filter(!is.na(ID))
MDR_all_newest_add_source_loc <- MDR_all_newest_fixed2 %>%
dplyr::mutate(`MAPS#Organism Name` = toupper(`MAPS#Organism Name`)) %>%
dplyr::left_join(Site_data, by = "Collection_site") %>%
dplyr::left_join(
TRAC_data %>%
select(`Patient EMPI`, primary_time, ACCNO_TRAC, `Specimen Source`,
Specimen_group, clinical_location, organism_cleaned) %>%
mutate(Date_collection_TRAC = as.Date(primary_time)) %>%
distinct(),
by = c(
"MRN_MDR_fixed" = "Patient EMPI",
"ACCNO_MDR"     = "ACCNO_TRAC",
"Date_collection_MDR_fixed" = "Date_collection_TRAC",
"MAPS#Organism Name"        = "organism_cleaned"
)
) %>%
dplyr::rename(
Collection_site_MDR       = Collection_site,
Collection_site_group_MDR = Collection_site_group,
Collection_site_TRAC      = `Specimen Source`,
Collection_site_group_TRAC= Specimen_group,
Hospital_location_MDR     = Hospital_location,
Hospital_location_TRAC    = clinical_location
) %>%
mutate(
Collection_site_MDR = if_else(is.na(Collection_site_MDR), Collection_site_TRAC, Collection_site_MDR),
Collection_site_group_MDR = if_else(is.na(Collection_site_group_MDR), Collection_site_group_TRAC, Collection_site_group_MDR),
Hospital_location_TRAC = str_replace(Hospital_location_TRAC, "\\^\\^", ""),
`MAPS#Organism Name` = if_else(
!is.na(`MAPS#Organism Name`),
paste(
substr(`MAPS#Organism Name`, 1, 1),
tolower(substr(`MAPS#Organism Name`, 2, nchar(`MAPS#Organism Name`))),
sep = ""
),
NA_character_
)
) %>%
select(
`CP Short Title`:`Location#Position`,
Collection_site_MDR, Collection_site_group_MDR,
Hospital_location_MDR, Notes:`MAPS#Participant ID`, `MAPS#PI Name`
) %>%
distinct()
###############################################################################
## Step 2: pipeline
###############################################################################
source("/Users/heekukpark/cumc.columbia.edu/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_TRAC_MDR/4_Source_code/Go_trac_tool_set2_V2.R")
if(!is.null(dev.list())) dev.off()
rm(list=ls())
library(dplyr)
library(stringr)
library(readxl)
library(openxlsx)
library(tidyr)
library(lubridate)
setwd("/Volumes/DOM_ID$/LOWY_LAB/1_Current Lab Members/Dwayne/TRAC_MDR_New/7_Intermediates/")
MDR_all_newest <- readRDS("MDR_all_newest.rds")
#--- Read TRAC data (versions appear multiple times in the original code) ---
setwd("/Volumes/DOM_ID$/LOWY_LAB/1_Current Lab Members/Dwayne/Track_MDR/")
list.files("Monthly cleaned TRAC data",pattern = "\\.rds$")
Track_file <-"Monthly cleaned TRAC data/TRAC all susceptibility 2009.01.01 - 2025.08.05 WIDE.rds"
TRAC_data <- readRDS(Track_file) %>%
mutate(
organism_cleaned = toupper(organism_cleaned),
Date_collection_TRAC = as.Date(Date_collection_TRAC)
)
tail(TRAC_data$primary_time)
dim(TRAC_data)
colnames(TRAC_data)
tail(TRAC_data$ACCNO_2)
dim(TRAC_data)
#--- Read site crosswalk ---
Site_data <- read.xlsx("NEW_MDR_Merging/MDR Collection sites crosswalk.xlsx") %>%
mutate(Collection_site = toupper(Collection_site))
#--- Read POS data (positive cultures) ---
Pos_data <- readRDS("Monthly cleaned TRAC data/Positive cultures with encounter_id, demographics & susceptibility 2020-2025.rds")
tail(Pos_data$primary_time)
#--- Read Illumina Sequencing record ---
seq_data <- read.xlsx("NEW_MDR_merging/Sequencing_Record_Illumina_WGS.xlsx", sheet = 1, detectDates = TRUE) %>%
select(Isolate:`Notes.2`) %>%
distinct()
###############################################################################
## Step 2: pipeline
###############################################################################
source("/Users/heekukpark/cumc.columbia.edu/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_TRAC_MDR/4_Source_code/Go_trac_tool_set2_V2.R")
dim(MDR_TRAC_merged_fixed2)
dim(MDR_with_CRE)
normalize_acc <- function(s){
s <- toupper(as.character(s))
gsub("[^A-Z0-9]", "", s)   # 공백/하이픈 등 제거
}
TRAC_sus <- TRAC_data %>%
mutate(
ACC_merge = coalesce(as.character(ACCNO_TRAC), as.character(ACCNO), as.character(ACCNO_2)),
ACC_merge = normalize_acc(ACC_merge)
) %>%
select(
ACC_merge,
matches("(IMIPENEM|MEROPENEM|ERTAPENEM).+_sus", ignore.case = TRUE)
) %>%
distinct()
x <- MDR_TRAC_merged_fixed2 %>%
mutate(
ACC_merge = normalize_acc(ACCNO_MDR),
y = year(Date_collection_MDR_fixed)
)
x_aug <- x %>%
left_join(TRAC_sus, by = "ACC_merge", suffix = c("", "_TRACACC"))
sus_cols_trac <- paste0(sus_cols_now, "_TRACACC"); sus_cols_trac <- sus_cols_trac[sus_cols_trac %in% names(x_aug)]
for (i in seq_along(sus_cols_now)) {
dst <- sus_cols_now[i]; src <- sus_cols_trac[i]
if (!is.na(src) && src %in% names(x_aug)) {
x_aug[[dst]] <- dplyr::coalesce(x_aug[[dst]], x_aug[[src]])
}
}
is_resist <- function(x){
x <- toupper(as.character(x))
grepl("^(R|NS)$", x)
}
sus_cols <- names(x_aug)[grepl("(IMIPENEM|MEROPENEM|ERTAPENEM).+_sus$", names(x_aug), ignore.case = TRUE)]
devtools::install_github("bbagy/Gotools", force=T)
# ----- Libraries and functions ------#
# devtools::install_github("bbagy/Gotools", force=T)
library("magick")
library("Gotools")
Gotool_dependency()
# ----- Input ------#
project<-"Urine_MG"
masterdir <- "~/Columbia University Irving Medical Center/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_Ton_Vir/"
currentwd <- sprintf("%s/2_Analysis/20251024_MG/20251111_Kraken2/",masterdir)
setwd(sprintf("%s",currentwd))
#==========================================#
#=========    Read ASVs to ps     =========#
#==========================================#
ps_bac <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
bracken="1_out/20251111_bracken_mpa.txt",
kingdom="Bacteria"
);ps_bac
# ----- Libraries and functions ------#
# devtools::install_github("bbagy/Gotools", force=T)
library("magick")
library("Gotools")
Gotool_dependency()
# ----- Input ------#
project<-"Urine_MG"
masterdir <- "~/Columbia University Irving Medical Center/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_Ton_Vir/"
currentwd <- sprintf("%s/2_Analysis/20251024_MG/20251111_Kraken2/",masterdir)
setwd(sprintf("%s",currentwd))
ps_v <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
kingdom="Virus"
);ps_v
#==========================================#
#=========    Read ASVs to ps     =========#
#==========================================#
ps_bac <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
bracken="1_out/20251111_bracken_mpa.txt",
kingdom="Bacteria"
);ps_bac
Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
bracken="1_out/20251111_bracken_mpa.txt",
kingdom="Bacteria"
)
kraken2="1_out/20251111_kraken2_mpa.txt"
bracken="1_out/20251111_bracken_mpa.txt"
kingdom="Bacteria"
library(dplyr)
library(phyloseq)
kingdom <- match.arg(kingdom)
# ----------------------------
# 1. Kraken2 MPA load
# ----------------------------
kraken <- read.delim(kraken2, sep="\t", header=TRUE, check.names=FALSE)
kraken$ID <- as.character(kraken$ID)
if (is.null(bracken)) stop("Bracken file required for Bacteria.")
br <- read.delim(bracken, sep="\t", header=TRUE, check.names=FALSE)
# Extract species id
kraken$species_id <- sub(".*\\|s__", "s__", kraken$ID)
kraken$species_id[!grepl("^s__", kraken$species_id)] <- NA
parse_taxonomy <- function(x) {
parts <- unlist(strsplit(x,"\\|"))
get <- function(prefix){
m <- grep(paste0("^",prefix), parts, value=TRUE)
if (length(m)==0) return(NA)
return(sub("^[a-z]__+","",m))
}
return(c(
phylum  = get("p__"),
class   = get("c__"),
order   = get("o__"),
family  = get("f__"),
genus   = get("g__"),
species = get("s__")
))
}
taxonomy <- as.data.frame(
do.call(rbind, lapply(kraken$ID, parse_taxonomy)),
stringsAsFactors = FALSE
)
taxonomy_df <- cbind(species_id = kraken$species_id, taxonomy)
taxonomy_df$species_id <- gsub(" ","_", taxonomy_df$species_id)
merged <- merge(br, taxonomy_df, by.x="ID", by.y="species_id", all.x=TRUE)
ranks <- c("phylum","class","order","family","genus","species")
colnames(merged) <- sapply(colnames(merged), function(x){
if (x %in% ranks) paste0(toupper(substr(x,1,1)), substr(x,2,nchar(x)))
else x
})
merged[, ranks] <- lapply(merged[, ranks], function(x) ifelse(is.na(x),"Unknown",x))
ranks
ranks <- c("phylum","class","order","family","genus","species")
colnames(merged) <- sapply(colnames(merged), function(x){
if (x %in% ranks) paste0(toupper(substr(x,1,1)), substr(x,2,nchar(x)))
else x
})
merged[, ranks] <- lapply(merged[, ranks], function(x) ifelse(is.na(x),"Unknown",x))
ps_fun <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
kingdom="Fungi"
);ps_fun
ps_v <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
kingdom="Virus"
);ps_v
ranks
# safe rank selection
safe_ranks <- intersect(ranks, colnames(merged))
# only fill NA in the ranks that actually exist
merged[, safe_ranks] <- lapply(merged[, safe_ranks, drop=FALSE], function(x) {
ifelse(is.na(x), "Unknown", x)
})
otu_cols <- setdiff(colnames(merged), c("ID","Phylum","Class","Order","Family","Genus","Species"))
otu_mat <- as.matrix(merged[, otu_cols])
rownames(otu_mat) <- merged$ID
taxonomy <- merged[, c("Phylum","Class","Order","Family","Genus","Species")]
taxonomy$Rank1 <- "Bacteria"
taxonomy <- taxonomy[, c("Rank1","Phylum","Class","Order","Family","Genus","Species")]
rownames(taxonomy) <- rownames(otu_mat)
otu <- otu_table(otu_mat, taxa_are_rows=TRUE)
tax <- tax_table(as.matrix(taxonomy))
phyloseq(otu,tax)
#' Go_kraken2Extraction
#'
#' Parse Kraken2 (and optional Bracken) MPA output into a phyloseq object
#' with unified taxonomy for Bacteria, Virus, and Fungi.
#'
#' @description
#' This function extracts taxonomy and abundance tables from Kraken2 and
#' optionally Bracken outputs, then converts them into a standardized
#' phyloseq object with harmonized taxonomic ranks.
#'
#' Supported kingdoms:
#' - "Bacteria": Requires Bracken; merges taxonomy with refined abundance.
#' - "Virus": Kraken-only; missing taxonomic ranks are filled with "Unknown".
#' - "Fungi": Kraken-only; missing ranks also filled with "Unknown".
#'
#' The final taxonomy table always uses the rank order:
#' Rank1, Phylum, Class, Order, Family, Genus, Species.
#'
#' @param kraken2 Path to Kraken2 MPA file.
#' @param bracken Optional Bracken MPA file (required when kingdom = "Bacteria").
#' @param kingdom One of "Bacteria", "Virus", or "Fungi".
#'
#' @return A phyloseq object containing OTU + taxonomy tables.
#'
#' @author Heekuk Park (hp2523@@cumc.columbia.edu)
#'
#' @examples
#' \dontrun{
#'
#' # -----------------------
#' # Example 1: Bacteria
#' # Requires both Kraken2 and Bracken MPA files
#' # -----------------------
#' ps_bac <- Go_kraken2Extraction(
#'   kraken2 = "1_out/20251111_kraken2_mpa.txt",
#'   bracken = "1_out/20251111_bracken_mpa.txt",
#'   kingdom = "Bacteria"
#' )
#' print(ps_bac)
#'
#'
#' # -----------------------
#' # Example 2: Virus
#' # Kraken2 only (Bracken not needed)
#' # -----------------------
#' ps_vir <- Go_kraken2Extraction(
#'   kraken2 = "1_out/20251111_kraken2_mpa.txt",
#'   kingdom = "Virus"
#' )
#' print(ps_vir)
#'
#'
#' # -----------------------
#' # Example 3: Fungi
#' # Kraken2 only (Bracken not needed)
#' # -----------------------
#' ps_fun <- Go_kraken2Extraction(
#'   kraken2 = "1_out/20251111_kraken2_mpa.txt",
#'   kingdom = "Fungi"
#' )
#' print(ps_fun)
#'
#' }
#'
#' @export
Go_kraken2Extraction <- function(kraken2, bracken=NULL, kingdom=c("Bacteria","Virus","Fungi")) {
library(dplyr)
library(phyloseq)
kingdom <- match.arg(kingdom)
# ----------------------------
# 1. Kraken2 MPA load
# ----------------------------
kraken <- read.delim(kraken2, sep="\t", header=TRUE, check.names=FALSE)
kraken$ID <- as.character(kraken$ID)
# ==========================================================
#  CASE 1: VIRUS  (NO Bracken)
# ==========================================================
if (kingdom == "Virus") {
# Only keep viral rows
virus <- kraken %>% filter(grepl("^d__Viruses", ID))
virus$ID <- as.character(virus$ID)
# Keep ONLY species-level rows
virus <- virus[grepl("s__", virus$ID), ]
# --------------------
# Viral taxonomy parser
# --------------------
parse_viral_tax <- function(x) {
parts <- unlist(strsplit(x, "\\|"))
get <- function(prefix) {
m <- grep(paste0("^", prefix), parts, value=TRUE)
if (length(m)==0) return(NA)
return(sub("^[a-z]__+", "", m))
}
return(c(
Phylum = get("p__"),
Class  = get("c__"),
Order  = get("o__"),
Family = get("f__"),
Genus  = get("g__"),
Species= get("s__")
))
}
taxonomy <- as.data.frame(do.call(rbind, lapply(virus$ID, parse_viral_tax)))
# Replace NA → "Unknown"
taxonomy[is.na(taxonomy)] <- "Unknown"
taxonomy$Rank1 <- "Viruses"
taxonomy <- taxonomy[, c("Rank1","Phylum","Class","Order","Family","Genus","Species")]
rownames(taxonomy) <- virus$ID
# OTU matrix
otu_mat <- as.matrix(virus[, setdiff(colnames(virus),"ID")])
rownames(otu_mat) <- virus$ID
otu <- otu_table(otu_mat, taxa_are_rows=TRUE)
tax <- tax_table(as.matrix(taxonomy))
return(phyloseq(otu,tax))
}
# ==========================================================
#  CASE 2: BACTERIA  (Bracken REQUIRED)
# ==========================================================
if (kingdom == "Bacteria") {
if (is.null(bracken)) stop("Bracken file required for Bacteria.")
br <- read.delim(bracken, sep="\t", header=TRUE, check.names=FALSE)
# Extract species id
kraken$species_id <- sub(".*\\|s__", "s__", kraken$ID)
kraken$species_id[!grepl("^s__", kraken$species_id)] <- NA
parse_taxonomy <- function(x) {
parts <- unlist(strsplit(x,"\\|"))
get <- function(prefix){
m <- grep(paste0("^",prefix), parts, value=TRUE)
if (length(m)==0) return(NA)
return(sub("^[a-z]__+","",m))
}
return(c(
phylum  = get("p__"),
class   = get("c__"),
order   = get("o__"),
family  = get("f__"),
genus   = get("g__"),
species = get("s__")
))
}
taxonomy <- as.data.frame(
do.call(rbind, lapply(kraken$ID, parse_taxonomy)),
stringsAsFactors = FALSE
)
taxonomy_df <- cbind(species_id = kraken$species_id, taxonomy)
taxonomy_df$species_id <- gsub(" ","_", taxonomy_df$species_id)
merged <- merge(br, taxonomy_df, by.x="ID", by.y="species_id", all.x=TRUE)
ranks <- c("phylum","class","order","family","genus","species")
colnames(merged) <- sapply(colnames(merged), function(x){
if (x %in% ranks) paste0(toupper(substr(x,1,1)), substr(x,2,nchar(x)))
else x
})
# safe rank selection
safe_ranks <- intersect(ranks, colnames(merged))
# only fill NA in the ranks that actually exist
merged[, safe_ranks] <- lapply(merged[, safe_ranks, drop=FALSE], function(x) {
ifelse(is.na(x), "Unknown", x)
})
otu_cols <- setdiff(colnames(merged), c("ID","Phylum","Class","Order","Family","Genus","Species"))
otu_mat <- as.matrix(merged[, otu_cols])
rownames(otu_mat) <- merged$ID
taxonomy <- merged[, c("Phylum","Class","Order","Family","Genus","Species")]
taxonomy$Rank1 <- "Bacteria"
taxonomy <- taxonomy[, c("Rank1","Phylum","Class","Order","Family","Genus","Species")]
rownames(taxonomy) <- rownames(otu_mat)
otu <- otu_table(otu_mat, taxa_are_rows=TRUE)
tax <- tax_table(as.matrix(taxonomy))
return(phyloseq(otu,tax))
}
# ==========================================================
#  CASE 3: FUNGI (NO Bracken)
# ==========================================================
if (kingdom == "Fungi") {
fungi <- kraken %>% filter(grepl("k__Fungi", ID))
fungi <- fungi[grepl("s__", fungi$ID), ]  # species only
parse_fun_tax <- function(x){
parts <- unlist(strsplit(x,"\\|"))
get <- function(prefix){
m <- grep(paste0("^",prefix), parts, value=TRUE)
if (length(m)==0) return(NA)
return(sub("^[a-z]__+","",m))
}
return(c(
Phylum = get("p__"),
Class  = get("c__"),
Order  = get("o__"),
Family = get("f__"),
Genus  = get("g__"),
Species= get("s__")
))
}
taxonomy <- as.data.frame(do.call(rbind, lapply(fungi$ID, parse_fun_tax)))
taxonomy[is.na(taxonomy)] <- "Unknown"
taxonomy$Rank1 <- "Fungi"
taxonomy <- taxonomy[, c("Rank1","Phylum","Class","Order","Family","Genus","Species")]
rownames(taxonomy) <- fungi$ID
otu_mat <- as.matrix(fungi[, setdiff(colnames(fungi),"ID")])
rownames(otu_mat) <- fungi$ID
otu <- otu_table(otu_mat, taxa_are_rows=TRUE)
tax <- tax_table(as.matrix(taxonomy))
return(phyloseq(otu,tax))
}
}
#==========================================#
#=========    Read ASVs to ps     =========#
#==========================================#
ps_bac <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
bracken="1_out/20251111_bracken_mpa.txt",
kingdom="Bacteria"
);ps_bac
ps_v <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
kingdom="Virus"
);ps_v
ps_fun <- Go_kraken2Extraction(
kraken2="1_out/20251111_kraken2_mpa.txt",
kingdom="Fungi"
);ps_fun
# Go_emptyMap(ps.bracken, project)
sampledata <- read.csv("3_map/25111.Urine_MG.mapping_virus.csv",row.names=1,check.names=FALSE)
# Go_emptyMap(ps.bracken, project)
sampledata <- read.csv("3_map/25111.Urine_MG.mapping.csv",row.names=1,check.names=FALSE)
# Go_emptyMap(ps.bracken, project)
sampledata <- read.csv("3_map/251111.Urine_MG.mapping.csv",row.names=1,check.names=FALSE)
ps1 <- merge_phyloseq(ps_v,sample_data(data.frame(sampledata)));ps1
ps1 <- merge_phyloseq(ps_bac,sample_data(data.frame(sampledata)));ps1
ps1.prune <- prune_taxa(taxa_to_keep, ps1);ps1.prune
ps2 <- Go_filter(ps1.prune,cutoff = 0.00001) #  0.00001
ps1 <- merge_phyloseq(ps_bac,sample_data(data.frame(sampledata)));ps1
ps1.prune <- prune_taxa(taxa_to_keep, ps1);ps1.prune
ps2 <- Go_filter(ps1.prune,cutoff = 0.00001) #  0.00001
# control spikin
exclude_species  <-  c("Allobacillus halotolerans", "Imtechella halotolerans")
taxa_to_keep <- taxa_names(ps1)[!(tax_table(ps1)[, "Species"] %in% exclude_species)]
ps1.prune <- prune_taxa(taxa_to_keep, ps1);ps1.prune
ps2 <- Go_filter(ps1.prune,cutoff = 0.00001) #  0.00001
variation <- c("ADTKD","Groups")
conf <- NULL # "StudyID"을 넣으면 결과가 너무 많이 나온다.
orders <- c("MUC1", "Healthy Control","Male", "Female","MUC1_Male", "MUC1_Female","Healthy Control_Male", "Healthy Control_Female")
variation <- c("ADTKD","Groups")
variation <- c("ADTKD") #,"Groups")
conf <- NULL # "StudyID"을 넣으면 결과가 너무 많이 나온다.
Go_Deseq2(ps2,  project, cate.outs = variation, cont.conf = NULL,cate.conf=NULL,orders= orders,name=NULL)
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
# if added some function do document again (include namespace)
devtools::document()
