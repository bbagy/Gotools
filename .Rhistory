Eclipsys <-  readRDS("2_TRAC_input/Eclipsys since 2009.01.01 WIDE.rds") # Just old data merging. it is not using anymore.
Epic_wide_new <- readRDS("Monthly cleaned TRAC data/Epic WIDE new.rds")
NEW.re <- gsub("-",".",NEW);NEW.re
Go_mergeEclipsysEpic(Eclipsys, Epic_wide_new, currentUpdate=NEW.re)
# clean memory
rm(Eclipsys, Epic_wide_new)
#---------------------------------------#
#---Step 5: New antibiotics graphs(1)---#
#---------------------------------------#
# Create the output directory using the date part
update <-  gsub("-","",NEW);update
out <- file.path("New antibiotics resistance/image", update)
if(!dir.exists(out)) dir.create(out, recursive = TRUE)
# Includes both meropenem and meropenem-vaborbactam
TRAC_wide_all_new <- readRDS(sprintf("Monthly cleaned TRAC data/TRAC all susceptibility 2009.01.01 - %s WIDE.rds",NEW.re))
Go_cleanABXtab(TRAC_wide_all_new)
# plot 1
KP_new_antibio_sum_res_long <- readRDS("New antibiotics resistance/KP_new_antibio_sum_res_long.rds")
p_carba_tested_new_antibio_over_years <- ggplot(data = KP_new_antibio_sum_res_long) +
geom_bar(aes(x = Year_collection, y = n, fill = Resistance), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of resistant isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for new antibiotics and having RESISTANCE (2009-2024)") +
scale_fill_discrete(breaks = c("Carbapenem", "New antibiotics tested", "Polymyxin B", "Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) +
scale_fill_manual(values = c("#FB9A99", "#E41A1C", "#1F78B4", "#6A3D9A", "#33A02C", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename = file.path(out, "Number of K. pneumoniae isolates tested & resistant to Carbapenem and new antibiotics over years.pdf"),
plot = p_carba_tested_new_antibio_over_years, height = 6, width = 10, dpi = 300)
# plot 2
KP_new_antibio_sum_res_long <- readRDS("New antibiotics resistance/KP_new_antibio_sum_res_long.rds")
p_ca_mv_cefi_2021_2024 <- ggplot(data = KP_new_antibio_sum_res_long %>%
dplyr::mutate(Year_collection = as.numeric(Year_collection)) %>%  # Convert to numeric
dplyr::filter(between(Year_collection, 2021, 2024) & Resistance %in%
c("Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) %>%
dplyr::mutate(n = replace_na(n, 0))) +
geom_bar(aes(x = Year_collection, y = n, fill = Resistance), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of resistant isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates having RESISTANCE to 3 new antibiotics (2021-2024)") +
scale_fill_discrete(breaks = c("Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) +
scale_fill_manual(values = c("#6A3D9A", "#33A02C", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename =file.path(out,"Number of Carbapenem-resistant K. pneumoniae isolates resistant to 3 new antibiotics (2021-2024).pdf"),
plot = p_ca_mv_cefi_2021_2024, height = 6, width = 10, dpi = 300)
rm(KP_new_antibio_sum_res_long)
#---------------------------------------#
#---Step 6: New antibiotics graphs(2)---#
#---------------------------------------#
KP_carba_res_new_antibio_tmp <- readRDS("New antibiotics resistance/CRKP new antibiotics from TRAC (I to R).rds")
Go_KP_ABX(KP_carba_res= KP_carba_res_new_antibio_tmp)
# plot 3
KP_carba_res_poly_sus <- readRDS("New antibiotics resistance/KP_carba_res_poly_sus.rds")
p_carba_poly_susc_over_year <- ggplot(data = KP_carba_res_poly_sus) +
geom_bar(aes(x = Year_collection, y = n_poly, fill = `Polymyxin B susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for POLYMYXIN B susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#A6CEE3", "#1F78B4")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 4
KP_carba_res_MV_sus <- readRDS("New antibiotics resistance/KP_carba_res_MV_sus.rds")
p_carba_MV_susc_over_year <- ggplot(data = KP_carba_res_MV_sus) +
geom_bar(aes(x = Year_collection, y = n_mv, fill = `Meropenem-Vaborbactam susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for MEROPENEM-VABORBACTAM susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#B2DF8A", "#33A02C")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 5
KP_carba_res_CA_sus <- readRDS("New antibiotics resistance/KP_carba_res_CA_sus.rds")
p_carba_CA_susc_over_year <- ggplot(data = KP_carba_res_CA_sus) +
geom_bar(aes(x = Year_collection, y = n_ca, fill = `Ceftazidime-Avibactam susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for CEFTAZIDIME-AVIBACTAM susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#CAB2D6", "#6A3D9A")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 6
KP_carba_res_cefi_sus <- readRDS("New antibiotics resistance/KP_carba_res_cefi_sus.rds")
p_carba_cefi_susc_over_year <- ggplot(data = KP_carba_res_cefi_sus) +
geom_bar(aes(x = Year_collection, y = n_cefi, fill = `Cefiderocol susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for CEFIDEROCOL susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#FDBF6F", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot merge 3 to 6
p_carba_new_antibio_susc_over_year <- p_carba_poly_susc_over_year + p_carba_MV_susc_over_year + p_carba_CA_susc_over_year + p_carba_cefi_susc_over_year
ggsave(filename = file.path(out, "Number of Carbapenem-resistant K. pneumoniae isolates tested for 4 new antibiotics over years.pdf"),
plot = p_carba_new_antibio_susc_over_year, height = 12, width = 20, dpi = 300)
# clean memory
rm(KP_carba_res_poly_sus, KP_carba_res_MV_sus, KP_carba_res_CA_sus,KP_carba_res_cefi_sus)
#---------------------------------------#
#---Step 6: New antibiotics graphs(3)---#
#---------------------------------------#
# plot 6
KP_carba_res_CA_MV_cefi_sus <- readRDS("New antibiotics resistance/KP_carba_res_CA_MV_cefi_sus.rds")
p_carba_new_antibio_susc_2021_2024 <- ggplot(data = KP_carba_res_CA_MV_cefi_sus %>%
dplyr::mutate(Year_collection = as.numeric(Year_collection)) %>%  # Convert to numeric
dplyr::filter(between(Year_collection, 2021, 2024))) +
geom_bar(aes(x = Year_collection, y = n, fill = Susceptibility), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates and susceptibility against 3 new antibiotics (2021-2024)") +
scale_fill_discrete(breaks = c("Ceftazidime-Avibactam Susceptible", "Ceftazidime-Avibactam Resistant", "Meropenem-Vaborbactam Susceptible", "Meropenem-Vaborbactam Resistant", "Cefiderocol Susceptible", "Cefiderocol Resistant")) +
scale_fill_manual(values = c("#CAB2D6", "#6A3D9A", "#B2DF8A", "#33A02C", "#FDBF6F", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename = file.path(out, "Number of Carbapenem-resistant K. pneumoniae isolates tested for 3 new antibiotics (2021-2024).pdf"),
plot = p_carba_new_antibio_susc_2021_2024, height = 6, width = 10, dpi = 300)
############################################################
# tab
KP_carba_res_new_antibio_sequenced_long <- KP_carba_res_new_antibio_tmp %>%
mutate(MRN_TRAC = as.numeric(MRN_TRAC)) %>%
left_join(readRDS("/Volumes/DOM_ID$/LOWY_LAB/0_Old_lab_members/Lingsheng/NEW_MDR_merging/Cleaned data/MDR all entries (added collection sites & clinical locations).rds") %>% mutate(`MAPS#Organism Name` = toupper(`MAPS#Organism Name`)) %>% select(Specimen_Label_combined, MRN_MDR_fixed, ACCNO_MDR, `MAPS#Organism Name`, Date_collection_MDR_fixed) %>% distinct(), by = c("MRN_TRAC" = "MRN_MDR_fixed", "ACCNO_TRAC" = "ACCNO_MDR", "organism_cleaned" = "MAPS#Organism Name", "Date_collection_TRAC" = "Date_collection_MDR_fixed")) %>%
left_join(readRDS("/Volumes/DOM_ID$/LOWY_LAB/0_Old_lab_members/Lingsheng//NEW_MDR_merging/Cleaned data/Sequencing data processed long.rds") %>% mutate(Organism_cleaned_seq = toupper(Organism_cleaned_seq)), by = c("Specimen_Label_combined" = "Isolate", "organism_cleaned" = "Organism_cleaned_seq")) %>%
mutate(Year_sequenced = case_when(Date_sequenced_new %in% c("BGI", "NYGC", "NYGC_Pilot") ~ Date_sequenced_new,
!is.na(Date_sequenced_new) ~ substr(Date_sequenced_new, 1, 4),
TRUE ~ NA_character_)) %>%
mutate(TRAC_KP_MDR_seqed = case_when(!is.na(Unique_ID) ~ "Sequenced",
!is.na(Specimen_Label_combined) ~ "In MDR not sequenced",
TRUE ~ "Not in MDR")) %>%
select(Unifier_TRAC = Unifier, MRN_TRAC:new_antibio_tested_ever, Specimen_Label_combined, TRAC_KP_MDR_seqed, Year_collection, Year_sequenced, everything()) %>%
distinct()
KP_carba_res_new_antibio_sequenced_sum_col_yr <- KP_carba_res_new_antibio_sequenced_long %>%
dplyr::select(Year_collection, TRAC_KP_MDR_seqed, Specimen_Label_combined) %>%
dplyr::group_by(Year_collection, TRAC_KP_MDR_seqed) %>%
dplyr::summarize(n = n())
View(KP_carba_res_new_antibio_sequenced_sum_col_yr)
#----------------------------------#
#---    Step 1: Data Update     ---#
#----------------------------------#
list.files("1_TRAC")
#####################################
#=====      TRAC and MDR       =====#
#####################################
#===== Clean and initialization
rm(list = ls())
#===== Set the source code and packages
source("/Users/heekukpark/cumc.columbia.edu/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_TRAC_MDR/4_Source_code/Go_trac_tool_set1_V3.R")
packages <- c("tidyverse","lubridate","readxl","openxlsx","data.table","ggplot2","patchwork")
for (package in packages){
install_and_load(package)
}
#===== Set working directory
setwd("/Volumes/DOM_ID$/LOWY_LAB/1_Current Lab Members/Dwayne/Track_MDR/")
#----------------------------------#
#---    Step 1: Data Update     ---#
#----------------------------------#
list.files("1_TRAC")
CURRENT <- "2025-07-07"
NEW <- "2025-08-05"
Go_SusReport(Epic_SusReport_RDS = sprintf("3_Updates/%s/RITM0413262_Epic_SusReport_updated_%s.rds",CURRENT,CURRENT),
Curr_SusReport_CSV = sprintf("1_TRAC/%s/RITM0413262_Epic_SusReport_%s.csv",NEW,NEW))
Epic_SusReport_RDS = sprintf("3_Updates/%s/RITM0413262_Epic_SusReport_updated_%s.rds",CURRENT,CURRENT)
Curr_SusReport_CSV = sprintf("1_TRAC/%s/RITM0413262_Epic_SusReport_%s.csv",NEW,NEW)
#----------------------------------#
#---   Step 2: Manipulate data  ---#
#----------------------------------#
culture_sus_epic_cleaned <- readRDS(sprintf("1_TRAC/%s/Cleaned_susceptibility_testing_subset_Epic_%s.rds",NEW,NEW))
Go_MIX_wide(Cleaned_sus = culture_sus_epic_cleaned)
# clean memory
rm(culture_sus_epic_cleaned)
#----------------------------------#
#---    Step 3: Data Update     ---#
#----------------------------------#
encounter_poscul_epic <- Go_PosCulture(Epic_PosCulture_CSV=sprintf("3_Updates/%s/RITM0413262_Epic_PosCulture_updated_%s.csv",CURRENT,CURRENT),
Curr_PosCulture_CSV = sprintf("1_TRAC/%s/RITM0413262_EpicPosCulture_%s.csv",NEW,NEW))
encounter_location <- Go_location(Epic_location_RDS =sprintf("3_Updates/%s/RITM0413262_Epic_Location_updated_%s.rds",CURRENT,CURRENT),
Curr_location_CSV = sprintf("1_TRAC/%s/RITM0413262_Epic_Location_%s.csv",NEW,NEW))
Epic_wide <- readRDS("Monthly cleaned TRAC data/Epic WIDE.rds")
Go_getEncounterID(Epic_wide, encounter_poscul_epic, encounter_location) #  p drive issue. Skip for now
# "P:/Fellows Research Folder/COVID_Database_2.0/Analysis/Lingsheng/2_covid_address/patients_from_covid_census.rds"
# clean memory
rm(encounter_poscul_epic, encounter_location, Epic_wide)
#----------------------------------------#
#---  Step 4: Merge Epic and Eclipsys ---#
#----------------------------------------#
Eclipsys <-  readRDS("2_TRAC_input/Eclipsys since 2009.01.01 WIDE.rds") # Just old data merging. it is not using anymore.
Epic_wide_new <- readRDS("Monthly cleaned TRAC data/Epic WIDE new.rds")
NEW.re <- gsub("-",".",NEW);NEW.re
Go_mergeEclipsysEpic(Eclipsys, Epic_wide_new, currentUpdate=NEW.re)
# clean memory
rm(Eclipsys, Epic_wide_new)
#---------------------------------------#
#---Step 5: New antibiotics graphs(1)---#
#---------------------------------------#
# Create the output directory using the date part
update <-  gsub("-","",NEW);update
out <- file.path("New antibiotics resistance/image", update)
if(!dir.exists(out)) dir.create(out, recursive = TRUE)
# Includes both meropenem and meropenem-vaborbactam
TRAC_wide_all_new <- readRDS(sprintf("Monthly cleaned TRAC data/TRAC all susceptibility 2009.01.01 - %s WIDE.rds",NEW.re))
Go_cleanABXtab(TRAC_wide_all_new)
# plot 1
KP_new_antibio_sum_res_long <- readRDS("New antibiotics resistance/KP_new_antibio_sum_res_long.rds")
p_carba_tested_new_antibio_over_years <- ggplot(data = KP_new_antibio_sum_res_long) +
geom_bar(aes(x = Year_collection, y = n, fill = Resistance), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of resistant isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for new antibiotics and having RESISTANCE (2009-2024)") +
scale_fill_discrete(breaks = c("Carbapenem", "New antibiotics tested", "Polymyxin B", "Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) +
scale_fill_manual(values = c("#FB9A99", "#E41A1C", "#1F78B4", "#6A3D9A", "#33A02C", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename = file.path(out, "Number of K. pneumoniae isolates tested & resistant to Carbapenem and new antibiotics over years.pdf"),
plot = p_carba_tested_new_antibio_over_years, height = 6, width = 10, dpi = 300)
# plot 2
KP_new_antibio_sum_res_long <- readRDS("New antibiotics resistance/KP_new_antibio_sum_res_long.rds")
p_ca_mv_cefi_2021_2024 <- ggplot(data = KP_new_antibio_sum_res_long %>%
dplyr::mutate(Year_collection = as.numeric(Year_collection)) %>%  # Convert to numeric
dplyr::filter(between(Year_collection, 2021, 2024) & Resistance %in%
c("Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) %>%
dplyr::mutate(n = replace_na(n, 0))) +
geom_bar(aes(x = Year_collection, y = n, fill = Resistance), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of resistant isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates having RESISTANCE to 3 new antibiotics (2021-2024)") +
scale_fill_discrete(breaks = c("Ceftazidime-Avibactam", "Meropenem-Vaborbactam", "Cefiderocol")) +
scale_fill_manual(values = c("#6A3D9A", "#33A02C", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename =file.path(out,"Number of Carbapenem-resistant K. pneumoniae isolates resistant to 3 new antibiotics (2021-2024).pdf"),
plot = p_ca_mv_cefi_2021_2024, height = 6, width = 10, dpi = 300)
rm(KP_new_antibio_sum_res_long)
#---------------------------------------#
#---Step 6: New antibiotics graphs(2)---#
#---------------------------------------#
KP_carba_res_new_antibio_tmp <- readRDS("New antibiotics resistance/CRKP new antibiotics from TRAC (I to R).rds")
Go_KP_ABX(KP_carba_res= KP_carba_res_new_antibio_tmp)
# plot 3
KP_carba_res_poly_sus <- readRDS("New antibiotics resistance/KP_carba_res_poly_sus.rds")
p_carba_poly_susc_over_year <- ggplot(data = KP_carba_res_poly_sus) +
geom_bar(aes(x = Year_collection, y = n_poly, fill = `Polymyxin B susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for POLYMYXIN B susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#A6CEE3", "#1F78B4")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 4
KP_carba_res_MV_sus <- readRDS("New antibiotics resistance/KP_carba_res_MV_sus.rds")
p_carba_MV_susc_over_year <- ggplot(data = KP_carba_res_MV_sus) +
geom_bar(aes(x = Year_collection, y = n_mv, fill = `Meropenem-Vaborbactam susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for MEROPENEM-VABORBACTAM susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#B2DF8A", "#33A02C")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 5
KP_carba_res_CA_sus <- readRDS("New antibiotics resistance/KP_carba_res_CA_sus.rds")
p_carba_CA_susc_over_year <- ggplot(data = KP_carba_res_CA_sus) +
geom_bar(aes(x = Year_collection, y = n_ca, fill = `Ceftazidime-Avibactam susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for CEFTAZIDIME-AVIBACTAM susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#CAB2D6", "#6A3D9A")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot 6
KP_carba_res_cefi_sus <- readRDS("New antibiotics resistance/KP_carba_res_cefi_sus.rds")
p_carba_cefi_susc_over_year <- ggplot(data = KP_carba_res_cefi_sus) +
geom_bar(aes(x = Year_collection, y = n_cefi, fill = `Cefiderocol susceptibility`), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates being tested for CEFIDEROCOL susceptibility (2009-2024)") +
scale_fill_discrete(breaks = c("Susceptible", "Resistant")) +
scale_fill_manual(values = c("#FDBF6F", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
# plot merge 3 to 6
p_carba_new_antibio_susc_over_year <- p_carba_poly_susc_over_year + p_carba_MV_susc_over_year + p_carba_CA_susc_over_year + p_carba_cefi_susc_over_year
ggsave(filename = file.path(out, "Number of Carbapenem-resistant K. pneumoniae isolates tested for 4 new antibiotics over years.pdf"),
plot = p_carba_new_antibio_susc_over_year, height = 12, width = 20, dpi = 300)
# clean memory
rm(KP_carba_res_poly_sus, KP_carba_res_MV_sus, KP_carba_res_CA_sus,KP_carba_res_cefi_sus)
#---------------------------------------#
#---Step 6: New antibiotics graphs(3)---#
#---------------------------------------#
# plot 6
KP_carba_res_CA_MV_cefi_sus <- readRDS("New antibiotics resistance/KP_carba_res_CA_MV_cefi_sus.rds")
p_carba_new_antibio_susc_2021_2024 <- ggplot(data = KP_carba_res_CA_MV_cefi_sus %>%
dplyr::mutate(Year_collection = as.numeric(Year_collection)) %>%  # Convert to numeric
dplyr::filter(between(Year_collection, 2021, 2024))) +
geom_bar(aes(x = Year_collection, y = n, fill = Susceptibility), position = "dodge2", stat = "identity") +
labs(x = "Isolates collection year", y = "Number of isolates", title = "Number of Carbapenem-resistant K. pneumoniae isolates and susceptibility against 3 new antibiotics (2021-2024)") +
scale_fill_discrete(breaks = c("Ceftazidime-Avibactam Susceptible", "Ceftazidime-Avibactam Resistant", "Meropenem-Vaborbactam Susceptible", "Meropenem-Vaborbactam Resistant", "Cefiderocol Susceptible", "Cefiderocol Resistant")) +
scale_fill_manual(values = c("#CAB2D6", "#6A3D9A", "#B2DF8A", "#33A02C", "#FDBF6F", "#FF7F00")) +
scale_y_continuous(limits = c(0, NA)) +
theme_bw() +
theme(legend.position = "bottom") +
theme(plot.title = element_text(size = 11))
ggsave(filename = file.path(out, "Number of Carbapenem-resistant K. pneumoniae isolates tested for 3 new antibiotics (2021-2024).pdf"),
plot = p_carba_new_antibio_susc_2021_2024, height = 6, width = 10, dpi = 300)
############################################################
# tab
KP_carba_res_new_antibio_sequenced_long <- KP_carba_res_new_antibio_tmp %>%
mutate(MRN_TRAC = as.numeric(MRN_TRAC)) %>%
left_join(readRDS("/Volumes/DOM_ID$/LOWY_LAB/0_Old_lab_members/Lingsheng/NEW_MDR_merging/Cleaned data/MDR all entries (added collection sites & clinical locations).rds") %>% mutate(`MAPS#Organism Name` = toupper(`MAPS#Organism Name`)) %>% select(Specimen_Label_combined, MRN_MDR_fixed, ACCNO_MDR, `MAPS#Organism Name`, Date_collection_MDR_fixed) %>% distinct(), by = c("MRN_TRAC" = "MRN_MDR_fixed", "ACCNO_TRAC" = "ACCNO_MDR", "organism_cleaned" = "MAPS#Organism Name", "Date_collection_TRAC" = "Date_collection_MDR_fixed")) %>%
left_join(readRDS("/Volumes/DOM_ID$/LOWY_LAB/0_Old_lab_members/Lingsheng//NEW_MDR_merging/Cleaned data/Sequencing data processed long.rds") %>% mutate(Organism_cleaned_seq = toupper(Organism_cleaned_seq)), by = c("Specimen_Label_combined" = "Isolate", "organism_cleaned" = "Organism_cleaned_seq")) %>%
mutate(Year_sequenced = case_when(Date_sequenced_new %in% c("BGI", "NYGC", "NYGC_Pilot") ~ Date_sequenced_new,
!is.na(Date_sequenced_new) ~ substr(Date_sequenced_new, 1, 4),
TRUE ~ NA_character_)) %>%
mutate(TRAC_KP_MDR_seqed = case_when(!is.na(Unique_ID) ~ "Sequenced",
!is.na(Specimen_Label_combined) ~ "In MDR not sequenced",
TRUE ~ "Not in MDR")) %>%
select(Unifier_TRAC = Unifier, MRN_TRAC:new_antibio_tested_ever, Specimen_Label_combined, TRAC_KP_MDR_seqed, Year_collection, Year_sequenced, everything()) %>%
distinct()
KP_carba_res_new_antibio_sequenced_sum_col_yr <- KP_carba_res_new_antibio_sequenced_long %>%
dplyr::select(Year_collection, TRAC_KP_MDR_seqed, Specimen_Label_combined) %>%
dplyr::group_by(Year_collection, TRAC_KP_MDR_seqed) %>%
dplyr::summarize(n = n())
View(KP_carba_res_new_antibio_sequenced_sum_col_yr)
rm(list=ls())
# ----- Libraries and functions ------#
# install.packages("devtools")
# devtools::install_github("bbagy/Gotools", force=T)
library("magick")
library("Gotools")
Gotool_dependency()
ps.asv <- Go_tabTops(csv ="1_out/Yael_Rejection.updated_sequences_with_blast_results.250810_cleaned.csv" ,project)
# ----- Input ------#
project<-"Yael_Rejection"
setwd("~/cumc.columbia.edu/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_Yae_PLT/2_Analysis/20230626_Yael_merged/")
#==========================================#
#=========    Read ASVs to ps     =========#
#==========================================#
ps <- readRDS("2_rds/ps.mergedbystudyID..230626.rds");ps
ps.asv <- Go_tabTops(csv ="1_out/Yael_Rejection.updated_sequences_with_blast_results.250810_cleaned.csv" ,project)
ps.asv <- Go_tabTops(csv ="1_out/Yael_Rejection.updated_sequences_with_blast_results.250810_cleaned.csv" ,project)
# for general
sampledata <- read.csv("3_map/Rejection/updatedmap16s.csv",row.names=1,check.names=FALSE)
tree <- read_tree("1_out/Yael.PLT.230626.psTotab.seqs.fna_tree/exported-tree/tree.nwk", errorIfNULL = T)
new_tre <- ape::multi2di(tree)
ps2 <- merge_phyloseq(ps.asv, phy_tree(tree),sample_data(data.frame(sampledata)));ps2
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
#===== alpha diversity
adiv <- Go_adiv(psIN = ps2,  project = project, alpha_metrics = c("Chao1","Shannon","PD"));dim(adiv)
boxcol <- Go_myCols(piratepal = "info");boxcol
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
#==========================================#
#=========        setting 1      ==========#
#==========================================#
#===== Orders
orders <- c("Control","Case", "NoRej",  "Mild", "ModSevere","Pre", "wk1_Post", "mo1_Post", "mo2_Post", "mo3-4_Post", "mo6_Post")
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("caselabel","severity_cat2"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("caselabel","severity_cat2"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,paired = "StudyID",
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("caselabel"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
View(sampledata)
table(mapIN$tp)
table(sampledata$tp)
# for general
sampledata <- read.csv("3_map/Rejection/updatedmap16s.csv",row.names=1,check.names=FALSE)
table(sampledata$caselabel, mapIN$ctp_class)
table(sampledata$caselabel, mapIN$ctp_class)
table(sampledata$caselabel, mapIN$ctp_class)
table(sampledata$caselabel, sampledata$ctp_class)
table(sampledata$caselabel, sampledata$ctp_class)
table(sampledata$rej_days_post_txp)
table(sampledata$severity_cat2)
table(sampledata$severity_cont)
table(sampledata$dxsimple)
table(sampledata$tp)
# for general
sampledata <- read.csv("3_map/Rejection/20250808_updatedmap16s.csv",row.names=1,check.names=FALSE)
tree <- read_tree("1_out/Yael.PLT.230626.psTotab.seqs.fna_tree/exported-tree/tree.nwk", errorIfNULL = T)
new_tre <- ape::multi2di(tree)
ps2 <- merge_phyloseq(ps.asv, phy_tree(tree),sample_data(data.frame(sampledata)));ps2
table(sampledata$caselabel, sampledata$ctp_class)
table(sampledata$rej_days_post_txp)
table(sampledata$severity_cat2)
table(sampledata$severity_cont)
table(sampledata$dxsimple)
table(sampledata$tp)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
#===== alpha diversity
adiv <- Go_adiv(psIN = ps2,  project = project, alpha_metrics = c("Chao1","Shannon","PD"));dim(adiv)
boxcol <- Go_myCols(piratepal = "info");boxcol
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 5, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 2.5, width = 10, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "StudyID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
# ----- Libraries and functions ------#
# devtools::install_github("bbagy/Gotools", force=T)
library("magick")
library("Gotools")
Gotool_dependency()
# ----- Input ------#
project<-"CAU_MG"
currentwd <- "~/Documents/05_CAU/20250723_MG_CAU/4_kraken2//"
setwd(sprintf("%s",currentwd))
# 8. Load as ps
ps.bracken <- Go_tabTops(csv ="1_out/20250724_bracken_with_taxonomy_modi.csv",project);ps.bracken
# Go_emptyMap(ps.bracken, project)
sampledata <- read.csv("3_map/250724.CAU_MG.mapping.csv",row.names=1,check.names=FALSE)
ps1 <- merge_phyloseq(ps.bracken,sample_data(data.frame(sampledata)));ps1
ps2 <- Go_filter(ps1,cutoff = 0.00001) #  0.00001
project<-"CAU_MG"
unique(sampledata$StudyID)
# ----- Input ------#
project<-"Yael_Rejection"
setwd("~/cumc.columbia.edu/Uhlemann Lab - Microbiome Core/1_Projects/MAPS_Yae_PLT/2_Analysis/20230626_Yael_merged/")
ps.asv <- Go_tabTops(csv ="1_out/Yael_Rejection.updated_sequences_with_blast_results.250810_cleaned.csv" ,project)
# for general
sampledata <- read.csv("3_map/Rejection/20250808_updatedmap16s.csv",row.names=1,check.names=FALSE)
tree <- read_tree("1_out/Yael.PLT.230626.psTotab.seqs.fna_tree/exported-tree/tree.nwk", errorIfNULL = T)
new_tre <- ape::multi2di(tree)
ps2 <- merge_phyloseq(ps.asv, phy_tree(tree),sample_data(data.frame(sampledata)));ps2
#==========================================#
#=========        setting 1      ==========#
#==========================================#
#===== Orders
orders <- c("Control","Case", "NoRej",  "Mild", "ModSevere","Pre", "wk1_Post", "mo1_Post", "mo2_Post", "mo3-4_Post", "mo6_Post")
#===== Go_myCols()
cols2 <- Go_myCols(custumCols = "cols3");cols2
DAcol <- Go_myCols(piratepal = "pony");DAcol
Go_myCols(RColorBrewer= "Dark2")
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "UID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
table(adiv$tp)
unique(adiv$tp)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = 6,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "UID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = 6,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T,
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = 6,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "UID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
Go_boxplot(df=adiv, project = project, title = NULL, xangle = 90,  mycols = boxcol,combination = NULL,
cate.vars = c("tp"), outcomes = c("Chao1","Shannon","PD"),addnumber = T, paired = "UID",
orders = orders, star= F, facet = NULL, name = NULL, cutoff = 0.3,
height = 7, width = 10, plotCols=3, plotRows=1, standardsize = F)
Go_pairedperm()?
#===== Permanova
Go_pairedperm(psIN=log_phyloseq_norm, cate.vars = c("caselabel","severity_cat2"), project =project, distance_metrics=c("wunifrac","unifrac"),
cate.conf=NULL, des=NULL, name=NULL)
?Go_pairedperm()
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
# build package
setwd("~/Dropbox/04_Scripts/R_source/Gotools")
devtools::build() # generate Gotools_0.0.0.9000.tar.gz
devtools::document()
