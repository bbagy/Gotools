% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/Go_intoASVs_V12.R, R/Go_intoASVs_V13.R
\name{Go_intoASVs}
\alias{Go_intoASVs}
\title{Go_intoASVs}
\usage{
Go_intoASVs(
  psIN,
  project,
  level = "Genus",
  target = "all",
  method = c("simple", "nucdiv"),
  aligner = c("DECIPHER", "MAFFT"),
  min_asv = 3,
  min_abund = 10,
  clustering_cutoff = 0.995,
  trim_nt = 8,
  distance_gap = c("exclude", "include"),
  distance_model = c("raw", "JC69"),
  weighting = c("abundance", "entropy"),
  compute_ci = FALSE,
  n_boot = 200,
  seed = 123,
  n_cores = 4
)

Go_intoASVs(
  psIN,
  project,
  level = "Genus",
  target = "all",
  method = c("simple", "nucdiv"),
  aligner = c("DECIPHER", "MAFFT"),
  min_asv = 3,
  min_abund = 10,
  clustering_cutoff = 0.995,
  trim_nt = 8,
  distance_gap = c("exclude", "include"),
  distance_model = c("raw", "JC69"),
  weighting = c("abundance", "entropy"),
  compute_ci = FALSE,
  n_boot = 200,
  seed = 123,
  n_cores = 4
)
}
\arguments{
\item{psIN}{A \code{phyloseq} object with ASV-level data and (optionally)
DNA sequences in \code{refseq(psIN)}.}

\item{project}{Character; project prefix used to create an output folder
\verb{<project_YYMMDD>/table/pi_tab/}.}

\item{level}{Character; taxonomic rank to group ASVs before computing π
(e.g., \code{"Genus"}, \code{"Family"}). Default \code{"Genus"}.}

\item{target}{Character; specific taxon name (e.g., \code{"Lactobacillus"}).
Use \code{"all"} to compute across all taxa. Default \code{"all"}.}

\item{method}{Character; one of \code{c("simple","nucdiv")}.
\code{"simple"} uses per-position Hamming distances; \code{"nucdiv"} uses
substitution models from \code{ape::dist.dna()}.}

\item{aligner}{Character; alignment engine, \code{"DECIPHER"} (R-based) or
\code{"MAFFT"} (external, faster if installed). Default \code{"DECIPHER"}.}

\item{min_asv}{Integer; minimum number of ASVs required to compute π. Default \code{3}.}

\item{min_abund}{Numeric; minimum total abundance per sample for inclusion. Default \code{10}.}

\item{clustering_cutoff}{Numeric; similarity cutoff for intra-taxon clustering
via \code{DECIPHER::IdClusters}. Default \code{0.995}.}

\item{trim_nt}{Integer; number of nucleotides to trim from both sequence ends
(useful for removing noisy termini of V3–V4 amplicons). Default \code{8}.}

\item{distance_gap}{Character; whether to \code{"exclude"} or \code{"include"} gaps
when computing nucleotide distances. Default \code{"exclude"}.}

\item{distance_model}{Character; substitution model for \code{method="nucdiv"}
(\code{"raw"}, \code{"JC69"}, etc.). Default \code{"raw"}.}

\item{weighting}{Character; weighting scheme for π:
\code{"abundance"} (relative abundance) or \code{"entropy"} (p·(1–p)). Default \code{"abundance"}.}

\item{compute_ci}{Logical; if \code{TRUE}, compute 95\\% bootstrap confidence intervals
(\code{n_boot} replicates). Default \code{FALSE}.}

\item{n_boot}{Integer; number of bootstrap replicates for CI. Default \code{200}.}

\item{seed}{Integer; random seed. Default \code{123}.}

\item{n_cores}{Integer; parallel cores for per-taxon computation. Default \code{4}.}
}
\value{
A \code{phyloseq} object identical to input but with new columns added
to \code{sample_data(psIN)} for each computed π and ASV count variable.
Also writes CSVs and a log file under the project folder.

A \code{phyloseq} object identical to input but with new columns added
to \code{sample_data(psIN)} for each computed π and ASV count variable.
Also writes CSVs and a log file under the project folder.
}
\description{
For each target taxon (or all taxa) in a \code{phyloseq} object, this function:
\itemize{
\item extracts ASV sequences (\code{refseq(psIN)} or rownames),
\item clusters intra-taxon sequences at \code{clustering_cutoff} (default 99.5\\%),
\item aligns sequences via \code{DECIPHER::AlignSeqs} or external \code{MAFFT},
\item trims both ends by \code{trim_nt} nt to remove V3–V4 terminal noise,
\item computes pairwise distances (\code{"simple"} = Hamming; or \code{"nucdiv"} = JC69, etc.),
\item calculates per-sample nucleotide diversity (π) weighted by relative abundance
or entropy, and (optionally) bootstrapped confidence intervals,
\item saves π and ASV-count matrices, and merges them into \code{sample_data(psIN)}.
}

For each target taxon (or all taxa) in a \code{phyloseq} object, this function:
\itemize{
\item extracts ASV sequences (\code{refseq(psIN)} or rownames),
\item clusters intra-taxon sequences at \code{clustering_cutoff} (default 99.5\\%),
\item aligns sequences via \code{DECIPHER::AlignSeqs} or external \code{MAFFT},
\item trims both ends by \code{trim_nt} nt to remove V3–V4 terminal noise,
\item computes pairwise distances (\code{"simple"} = Hamming; or \code{"nucdiv"} = JC69, etc.),
\item calculates per-sample nucleotide diversity (π) weighted by relative abundance
or entropy, and (optionally) bootstrapped confidence intervals,
\item saves π and ASV-count matrices, and merges them into \code{sample_data(psIN)}.
}
}
\details{
Compute intra-taxon nucleotide diversity (π) from ASV-level 16S sequences
within each taxon, optionally trimming noisy V3–V4 termini, clustering,
and bootstrapping CIs.

π (nucleotide diversity) is computed per sample as:
\deqn{π = 2 \sum_{i<j} w_i w_j d_{ij}}
where \(w_i\) are normalized weights (abundance- or entropy-based) and
\(d_{ij}\) is pairwise sequence distance.

When \code{compute_ci=TRUE}, 95\% CIs are estimated by bootstrap resampling
of ASVs within each sample. Clustering removes redundant ASVs within taxa
before alignment to reduce overcounting identical sequences.

The function always saves results in:
\itemize{
\item \code{pi_matrix_<method>_<level>_<target>_<date>.csv}
\item \code{asv_count_matrix_<level>_<target>_<date>.csv}
\item optional \code{pi_ci_low_matrix_*.csv}, \code{pi_ci_high_matrix_*.csv}
\item text log: \code{pi_log_<method>_<level>_<target>_<date>.txt}
}
and merges the computed π and ASV counts into \code{sample_data(psIN)} as:
new columns prefixed by \code{pi_} and \code{asvN_}.

Compute intra-taxon nucleotide diversity (π) from ASV-level 16S sequences
within each taxon, optionally trimming noisy V3–V4 termini, clustering,
and bootstrapping CIs.

π (nucleotide diversity) is computed per sample as:
\deqn{π = 2 \sum_{i<j} w_i w_j d_{ij}}
where \(w_i\) are normalized weights (abundance- or entropy-based) and
\(d_{ij}\) is pairwise sequence distance.

When \code{compute_ci=TRUE}, 95\% CIs are estimated by bootstrap resampling
of ASVs within each sample. Clustering removes redundant ASVs within taxa
before alignment to reduce overcounting identical sequences.

The function always saves results in:
\itemize{
\item \code{pi_matrix_<method>_<level>_<target>_<date>.csv}
\item \code{asv_count_matrix_<level>_<target>_<date>.csv}
\item optional \code{pi_ci_low_matrix_*.csv}, \code{pi_ci_high_matrix_*.csv}
\item text log: \code{pi_log_<method>_<level>_<target>_<date>.txt}
}
and merges the computed π and ASV counts into \code{sample_data(psIN)} as:
new columns prefixed by \code{pi_} and \code{asvN_}.
}
\examples{
\dontrun{
ps_pi <- Go_intoASVs(
  psIN = ps,
  project = "V34Study",
  level = "Genus",
  target = "Lactobacillus",
  method = "simple",
  aligner = "DECIPHER",
  trim_nt = 8,
  compute_ci = TRUE,
  n_boot = 100,
  n_cores = 4
)
sample_data(ps_pi)[, c("pi_Lactobacillus","asvN_Lactobacillus")]
}

\dontrun{
ps_pi <- Go_intoASVs(
  psIN = ps,
  project = "V34Study",
  level = "Genus",
  target = "Lactobacillus",
  method = "simple",
  aligner = "DECIPHER",
  trim_nt = 8,
  compute_ci = TRUE,
  n_boot = 100,
  n_cores = 4
)
sample_data(ps_pi)[, c("pi_Lactobacillus","asvN_Lactobacillus")]
}

}
\author{
Heekuk Park \href{mailto:hp2523@cumc.columbia.edu}{hp2523@cumc.columbia.edu}
}
